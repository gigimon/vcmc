# Description
Цель: сделать быстрый консольный файловый менеджер в стиле Midnight Commander с акцентом на отзывчивость UI и предсказуемые файловые операции.

Принятые решения:
- Язык: Rust (stable).
- TUI-стек: `ratatui` + `crossterm`.
- Архитектура: основной event loop + фоновые worker-потоки для долгих операций.
- Платформы первой итерации: macOS + Linux (POSIX-first).
- Удаление в v1: permanent delete с обязательным подтверждением.

Нефункциональные требования для v1:
- Быстрый старт и навигация по большим каталогам.
- UI не должен зависать во время копирования/перемещения.
- Минимальные аллокации в hot-path (рендер/навигация/листинг).
- Явные сообщения об ошибках и безопасные подтверждения для рискованных операций.

MVP-функции (итерация 1):
- Две панели (левая/правая), активная панель, переключение по `Tab`.
- Навигация: `Up/Down`, `Enter`, `Backspace`, переход к домашней директории.
- Операции: копировать, переместить, удалить (с подтверждением), создать папку.
- Сортировка: по имени/размеру/дате (переключаемые режимы).
- Поиск по имени в текущем каталоге.
- Строка подсказок с хоткеями и строка статуса (путь, число элементов, ошибки).

# Implementation

## Step 1: Bootstrap и каркас проекта
[x] Инициализировать `cargo`-проект (`bin`) и базовую структуру модулей.
[x] Подключить зависимости: `ratatui`, `crossterm`, `crossbeam-channel`, `walkdir`, `anyhow`, `thiserror`, `tracing`, `tracing-subscriber`.
[x] Описать базовые сущности: `AppState`, `PanelState`, `FsEntry`, `Command`, `Event`, `Job`.
[x] Добавить graceful shutdown и восстановление терминала при panic/ошибке.

## Step 2: Слой доменной модели и FS-адаптер
[x] Реализовать POSIX-ориентированный FS-адаптер (листинг, stat, mkdir, remove, rename/move, copy).
[x] Ввести нормализацию и валидацию путей (absolute/canonical где нужно).
[x] Добавить сортировки (name/size/mtime) и базовую фильтрацию скрытых файлов.
[x] Подготовить единый тип ошибок с понятной классификацией (permission, not found, io).

## Step 3: Event loop и конкурентная модель
[x] Реализовать главный цикл обработки: input events, ticks, worker responses.
[x] Поднять worker pool для долгих операций (copy/move/delete) через каналы.
[x] Добавить очередь задач и модель прогресса (`Queued`, `Running`, `Done`, `Failed`).
[x] Гарантировать неизменность UI-потока: любые тяжелые операции только через воркеры.

## Step 4: Базовый UI (две панели)
[x] Собрать layout: header, две панели, status bar, help bar.
[x] Реализовать визуальные состояния: активная панель, выделение, пустой каталог, ошибка.
[x] Добавить адаптацию к resize терминала.
[x] Настроить компактный рендер без лишних перерисовок состояния.

## Step 5: Навигация и управление фокусом
[x] Горячие клавиши: `Tab`, `Up/Down`, `Enter`, `Backspace`, `q`.
[x] Переход по каталогам и корректная обработка `..`.
[x] Поддержать быстрый jump в домашний каталог.
[x] Синхронизировать UI и `AppState` без рассогласований между панелями.

## Step 6: Файловые операции MVP
[x] Копирование из активной панели в неактивную (через job).
[x] Перемещение из активной панели в неактивную (через job).
[x] Удаление (permanent) с обязательным confirm-диалогом.
[x] Создание директории в активной панели.
[x] Показ результата операции и ошибок в status/log области.

## Step 7: Поиск и сортировка
[x] Реализовать поиск по подстроке имени в текущем каталоге (инкрементально).
[x] Добавить переключение режимов сортировки хоткеем.
[x] Сохранить выбранную сортировку per-panel.
[x] Обновлять видимый список без блокировки UI.

## Step 8: UX-доработки и надежность
[x] Добавить модальные окна подтверждений и ошибок (удаление/конфликты).
[x] Ввести стратегию конфликтов имен при copy/move (минимум: abort + сообщение).
[x] Улучшить сообщения об ошибках с контекстом пути/операции.
[x] Добавить guard-rails для опасных действий (удаление директории, permission denied).

## Step 9: Проверка производительности и релиз v1
[x] Smoke-проверка на больших каталогах (время первого листинга, latency навигации).
[x] Проверка поведения под долгими задачами копирования (UI отзывчив).
[x] Подготовить README: хоткеи, ограничения POSIX-first, known issues.
[x] Сформировать backlog для итерации 2 (архивы, предпросмотр, multi-select, tabs).

## Step 10: Rename Dialogs и табличный UI
[x] Добавить окно изменения имени для copy/move перед постановкой job.
[x] Показать список файлов в колонках `Name | Size | Modified`.
[x] Сохранить цветовую дифференциацию file/dir/symlink и корректный highlight selection.

# Definition of Done (итерация 1)
[x] Двухпанельная навигация стабильна и без UI-фризов.
[x] Основные операции (copy/move/delete/mkdir) выполняются через jobs и отображают статус.
[x] Поиск и сортировка работают в обеих панелях.
[x] Терминал корректно восстанавливается после штатного/аварийного выхода.
[x] Документация по запуску и хоткеям готова.

# Description (итерация 2)
Цель: сделать UX ближе к Midnight Commander для массовых операций и улучшить визуальную стабильность интерфейса.

Принятые решения:
- Selection-модель: MC-like (`Ins/Space`, `+/-/*`, диапазон `Shift+стрелки`).
- Таблица файлов: фиксированные колонки (`Name 64% | Size 14% | Modified 22%`).
- Нижнее меню: context-sensitive кнопки `F1..F10`.
- Диалоги: полноценные окна с кнопками (`[ OK ] [ Cancel ]`), фокусом и навигацией `Tab/Shift+Tab/Enter`.

Нефункциональные требования:
- Геометрия колонок не должна прыгать от длины имени файла.
- Диалоги должны быть единообразны по стилю и управлению.
- Массовые операции не должны блокировать UI.

# Implementation (итерация 2)

## Step 11: Selection Engine (MC-like)
[x] Добавить в `PanelState` модель multi-select (`selected_paths`, `selection_anchor`).
[x] Реализовать `Space/Ins` (toggle current), `+` (select by mask), `-` (deselect by mask), `*` (invert).
[x] Реализовать диапазонное выделение (`Shift+Up/Down`) с anchor-позицией.
[x] В status bar показывать счетчик выделенных (`selected N items / bytes`).

## Step 12: Batch Operations поверх selection
[x] Изменить `F5/F6/F8` на работу с набором выбранных элементов (если выбор пуст, использовать current).
[x] Добавить preflight-валидацию пакета: виртуальные записи, дубликаты, конфликтные target paths.
[x] Показать сводный confirm перед batch delete/move/copy (кол-во, объем, риски).
[x] Вести агрегированный прогресс/ошибки по пачке в activity log.

## Step 13: Стабильный табличный layout
[x] Зафиксировать ширины колонок от ширины панели: `64/14/22` без перерасчета от контента.
[x] Добавить предсказуемое обрезание имени (`…`) и выравнивание `Size/Modified`.
[x] Проверить поведение на узком терминале: fallback к compact-таблице без “ломания” сетки.
[x] Обновить рендер заголовка таблицы и highlight выбранных строк без дрожания.

## Step 14: UI Kit для диалогов с кнопками
[x] Ввести общий компонент диалога: title/body/footer buttons/focused button.
[x] Реализовать навигацию по кнопкам: `Tab/Shift+Tab`, `Left/Right`, `Enter`, `Esc`.
[x] Перевести текущие confirm/alert/rename в новый компонент с кнопками.
[x] Поддержать ускорители кнопок (`Alt+буква`) для частых действий.

## Step 15: Нижнее меню F-key в стиле MC
[x] Реализовать визуальные кнопки `F1..F10` в footer (`[F5 Copy] [F6 Move] ...`).
[x] Сделать context-sensitive наборы:
[x] `Normal`: базовые действия.
[x] `Selection`: batch-операции.
[x] `Dialog`: кнопки активного диалога (`OK/Cancel/Apply`).
[x] Подсветка disabled/active состояний для прозрачного UX.

## Step 16: Полировка и валидация итерации 2
[x] Smoke-сценарии для multi-select и batch copy/move/delete.
[x] Проверка стабильности layout на разных размерах терминала.
[x] Обновить README: новые hotkeys, selection flow, dialog controls.
[x] Добавить раздел Known UX constraints и дальнейший backlog (preview, tabs, bookmarks).

# Definition of Done (итерация 2)
[x] Multi-select работает предсказуемо и покрывает MC-like сценарии.
[x] Batch-операции безопасны и дают понятные сводные подтверждения/ошибки.
[x] Колонки стабильны и не меняют геометрию от длины имени.
[x] Все диалоги выглядят единообразно, имеют кнопки и управляются с клавиатуры.
[x] Нижнее меню F-кнопок контекстно соответствует режиму экрана.

# Description (итерация 3)
Цель: добавить богатый режим просмотра и редактирования в стиле MC+, сохранив скорость и клавиатурный workflow.

Принятые решения:
- Viewer: fullscreen по `F3` (без третьей колонки превью на этом этапе).
- Форматы в viewer v1: smart fallback:
  - текст: обычный построчный рендер;
  - подозрительно бинарный контент: lossy-preview первых N KB + metadata (size/path/type).
- Edit: `F4` открывает внешний редактор из `$EDITOR`.
- Текущий стек сохраняется: Rust stable + `ratatui` + `crossterm`.

Нефункциональные требования:
- Вход/выход из viewer должен быть мгновенным и предсказуемым.
- Открытие `$EDITOR` должно корректно восстанавливать TUI после возврата.
- Большие файлы не должны фризить UI (ленивая загрузка/лимиты чтения).

# Implementation (итерация 3)

## Step 17: Viewer Mode и доменная модель
[x] Добавить режим экрана `Viewer` в `AppState` (normal/viewer) и структуру `ViewerState`.
[x] В `ViewerState` хранить: `path`, `title`, `lines`, `scroll_offset`, `is_binary_like`, `byte_size`.
[x] Ввести команды/события для `F3`, закрытия viewer (`Esc/F3/q`) и вертикального скролла.
[x] Гарантировать, что переход в viewer не ломает выделения/позицию в панели при возврате.

## Step 18: Загрузка контента и smart fallback
[x] Реализовать `viewer_loader`: чтение файла с верхним лимитом (например 256 KB для preview).
[x] Добавить эвристику binary-like (NUL-байты/доля непечатаемых символов).
[x] Для текста: нормализация строк и табов, безопасное ограничение длины строки.
[x] Для binary-like: показывать metadata + lossy-предпросмотр первых N KB.

## Step 19: UI и управление fullscreen viewer (`F3`)
[x] Реализовать fullscreen-рендер viewer с header/body/footer hotkeys.
[x] Управление: `Up/Down`, `PgUp/PgDn`, `Home/End`, `Esc/F3` для выхода.
[x] Поддержать статус внизу viewer (offset, total lines/bytes, mode text/binary-like).
[x] Добавить обработку ошибок загрузки (permission denied, not found, read failure).

## Step 20: Интеграция внешнего редактора (`F4`)
[x] Реализовать запуск `$EDITOR <current_file>` с временным выходом из alternate screen.
[x] После завершения editor корректно вернуть raw mode/alternate screen и redraw.
[x] Добавить fallback, если `$EDITOR` не задан (alert + подсказка).
[x] Обновлять панель после возврата из editor (mtime/size/имя).

## Step 21: Полировка viewer/editor и документация
[x] Smoke-сценарий: `F3` на текстовом и binary-like файле + базовый скролл.
[x] Smoke-сценарий: `F4` roundtrip (запуск editor, возврат в TUI, refresh панели).
[x] Обновить README: хоткеи viewer/editor и ограничения smart fallback.
[x] Зафиксировать Known UX constraints и backlog следующего этапа (hex-mode, search in viewer, internal editor).

# Definition of Done (итерация 3)
[x] `F3` открывает fullscreen viewer без деградации UX панелей.
[x] Smart fallback корректно различает текст и binary-like и показывает понятный результат.
[x] `F4` через `$EDITOR` надежно возвращает пользователя обратно в TUI.
[x] Документация и smoke-сценарии покрывают новый workflow просмотра/редактирования.

# Description (итерация 4)
Цель: приблизить UX к классическому MC в части информативности операций и расширить менеджер до локально-удаленной работы (SFTP).

Принятые решения:
- Прогресс массовых операций: агрегированный (`N/M`) + текущий файл (MC-like).
- Нижние кнопки: адаптивная сетка на всю ширину экрана, визуально ближе к "настоящим" кнопкам MC.
- Цветовые темы/подсветка расширений: совместимость с `dircolors` (парсинг и маппинг в TUI-стили).
- Удаленный доступ: нативный SFTP backend на Rust (без shell-out в `scp/sftp`).

Нефункциональные требования:
- Прогресс должен обновляться без блокировки UI.
- Footer-кнопки должны быть стабильны и читаемы на узких терминалах.
- Тема должна иметь безопасный fallback при неполном/битом `dircolors`.
- Сетевые операции должны изолироваться в backend/jobs слое, без деградации локального UX.

# Implementation (итерация 4)

## Step 22: MC-like progress UI для batch операций
[x] Расширить `JobUpdate`/batch агрегатор: передавать текущий файл и прогресс по элементам пачки.
[x] Добавить прогресс-панель/оверлей в стиле MC: `Operation`, `Current file`, `Files: N/M`.
[x] Для delete/copy/move показывать общий прогресс и текущий элемент в реальном времени.
[x] Сохранить неблокирующий UI и корректное завершение/сброс состояния progress.

## Step 23: Footer-кнопки на всю ширину (adaptive MC style)
[x] Переработать footer в адаптивную full-width сетку с "кнопочным" видом.
[x] Добавить динамический layout для длинных подписей (`truncate`, `abbrev`) без дрожания геометрии.
[x] Обновить context sets (`Normal/Selection/Dialog/Viewer`) для новой сетки.
[x] Подсветить active/disabled/pressed состояния визуально ближе к MC.

## Step 24: Темы и подсветка расширений через `dircolors`
[x] Добавить парсер `dircolors` (основные токены: `DIR`, `LINK`, `EXEC`, `*.ext`, `RESET`).
[x] Построить маппинг `dircolors -> ratatui::Style` с fallback-темой по умолчанию.
[x] Применить расширенную раскраску в таблице файлов (по типу и расширению).
[x] Добавить hot-reload или reload по команде для теста тем в runtime.

## Step 25: Backend-абстракция и нативный SFTP backend
[x] Ввести `FsBackend` abstraction (`LocalFs`, `SftpFs`) для панелей и операций.
[x] Реализовать `SftpFs` на Rust-библиотеке (`ssh2`/эквивалент): list/stat/read/write/mkdir/remove/rename.
[x] Добавить UI-флоу подключения: host/user/port/path + auth (agent/key/password).
[x] Поддержать копирование `local <-> sftp` и `sftp -> sftp` через существующую job-модель.

## Step 26: Полировка сети, документация и smoke
[x] Добавить retry/timeout и понятные сетевые ошибки (auth/network/perm/path).
[x] Подготовить smoke-сценарии для progress UI и базовых SFTP операций на тестовом хосте.
[x] Обновить README: remote workflow, security notes, `dircolors`, progress controls.
[x] Зафиксировать ограничения v1 remote режима и backlog (resume, parallel transfers, bookmarks for hosts).

# Definition of Done (итерация 4)
[x] Пользователь видит понятный MC-like прогресс для batch операций (общий + текущий файл).
[x] Нижняя панель кнопок заполняет всю ширину экрана и остается читаемой в разных режимах.
[x] Подсветка файлов поддерживает `dircolors` и корректно деградирует при fallback.
[x] Работают подключение по SFTP и базовые операции/копирование между локальной и удаленной панелью.

# Description (итерация 5)
Цель: закрыть ключевые UX-функции уровня MC для ежедневной работы: верхнее меню, интерактивные конфликты, архивы как VFS, быстрый `find` на базе `fd`, улучшенный viewer и надежный выбор редактора.

Принятые решения:
- Командная строка и shell-режим официально фиксируются как уже реализованный функционал (post-factum в плане).
- Добавляется верхнее меню (MC-like menu bar) для группировки действий и быстрого доступа к SFTP/новым функциям.
- Конфликты copy/move переводятся с `abort-only` на интерактивную матрицу решений (`overwrite/skip/rename`) с `apply to all`.
- Поиск файлов делается через внешнюю утилиту `fd` (без написания собственного поискового движка).
- Архивы (`zip/tar/tar.gz`) открываются как VFS-панель через backend abstraction.
- Для `F4` при отсутствии `$EDITOR` добавляется автообнаружение популярных редакторов и first-run выбор с сохранением.

Нефункциональные требования:
- Меню и диалоги не должны блокировать UI.
- Интеграция `fd` должна иметь безопасный fallback при отсутствии бинарника в системе.
- VFS-архивы не должны ломать семантику существующих операций и job-модели.
- Выбор редактора должен быть детерминированным и сохраняться между сессиями.

# Implementation (итерация 5)

## Step 27: Командная строка и shell (закрытие план/факт)
[x] Зафиксировать в плане, что уже реализованы `:` command line и shell-режим.
[x] Документировать поддерживаемые сценарии (`cd`, shell-команды, интерактивные команды, `Ctrl+O` shell mode).
[x] Зафиксировать ограничения (shell только для local backend).
[x] Обновить backlog/итерации с учетом наличия этой функциональности.

## Step 28: Верхнее дополнительное меню (MC-like menu bar)
[x] Добавить верхнюю строку меню с группами действий (`Left`, `Options`, `Right`).
[x] Вынести подключение SFTP и файловые действия в `Left/Right` с быстрым запуском на выбранной стороне.
[x] Добавить в `Left/Right` входные точки для новых функций (Find, Archive VFS), а в `Options` для Viewer/Editor настроек.
[x] Реализовать клавиатурную навигацию меню (`F9/Alt+буква`, стрелки, Enter, Esc) без регрессий в основном режиме.

## Step 29: Матрица конфликтов copy/move
[x] Добавить интерактивный conflict-dialog: `Overwrite`, `Skip`, `Rename` + `Apply to all`.
[x] Поддержать стратегии `newer-only` и `size/mtime`-подсказки в теле диалога.
[x] Интегрировать conflict-policy в batch pipeline и прогресс (`N/M`, failed/skipped).
[x] Обновить обработку ошибок и activity log для прозрачного post-mortem.

## Step 30: Архивы как VFS (zip/tar/tar.gz)
[x] Ввести `ArchiveFs` backend и подключение как panel-mode поверх существующей `FsBackend` абстракции.
[x] Реализовать вход в архив по `Enter` как в каталог и навигацию внутри архива.
[x] Поддержать операции v1: browse + copy out (`archive -> local/sftp`), copy in как отдельный этап.
[x] Добавить явную индикацию, что панель находится в архивном VFS-режиме.

## Step 31: Find file через `fd` и panelized results
[x] Добавить команду поиска файлов на базе внешнего `fd` (`name`, `glob`, optional hidden/follow symlinks).
[x] Реализовать асинхронный запуск `fd` через job/workers с live-progress в status/footer.
[x] Показать результаты в виртуальной панели (panelized view) с переходом к исходному пути.
[x] Сделать fallback: если `fd` не найден, показать понятный диалог с подсказкой по установке.

## Step 32: Viewer+ (улучшения просмотра)
[] Добавить `hex-mode` для бинарных файлов и переключение режимов `text/hex`.
[] Добавить поиск внутри viewer (`/`, next/prev, highlight match).
[] Поддержать viewer для remote/SFTP файлов через ограниченный buffered read.
[] Добавить расширенный статус viewer (mode, offset, line/byte position, matches).

## Step 33: Editor Discovery и first-run chooser для `F4`
[] При отсутствии `$EDITOR` запускать автообнаружение популярных редакторов (`nvim`, `vim`, `nano`, `hx`, `micro`, `emacs`, `code -w`).
[] Показать first-run диалог выбора редактора из найденных вариантов.
[] Сохранять выбор в конфиг (`XDG config`/`~/.config/vcmc`) и использовать как default для `F4`.
[] Добавить пункт в верхнее меню для смены редактора без перезапуска.

## Step 34: Полировка итерации 5
[] Добавить smoke-сценарии: conflict-matrix, archive VFS browse/copy out, `fd` find, viewer search/hex, editor chooser.
[] Обновить README: верхнее меню, новый find-flow, conflict policies, archive VFS, editor setup.
[] Добавить Known constraints для `fd`/archive edge-cases и remote viewer limits.
[] Сформировать backlog итерации 6 (internal editor, sync dir compare, plugin hooks).

# Definition of Done (итерация 5)
[] Верхнее меню покрывает ключевые действия и не конфликтует с F-key workflow.
[] Конфликты copy/move решаются интерактивно без принудительного abort.
[] Архивы открываются как VFS и пригодны для реального browse/copy out workflow.
[] Find file через `fd` работает стабильно и дает panelized results.
[] Viewer поддерживает hex + search и работает для local/SFTP.
[] `F4` работает без `$EDITOR` через first-run выбор и сохраненный редактор.
