# Description
Цель: сделать быстрый консольный файловый менеджер в стиле Midnight Commander с акцентом на отзывчивость UI и предсказуемые файловые операции.

Принятые решения:
- Язык: Rust (stable).
- TUI-стек: `ratatui` + `crossterm`.
- Архитектура: основной event loop + фоновые worker-потоки для долгих операций.
- Платформы первой итерации: macOS + Linux (POSIX-first).
- Удаление в v1: permanent delete с обязательным подтверждением.

Нефункциональные требования для v1:
- Быстрый старт и навигация по большим каталогам.
- UI не должен зависать во время копирования/перемещения.
- Минимальные аллокации в hot-path (рендер/навигация/листинг).
- Явные сообщения об ошибках и безопасные подтверждения для рискованных операций.

MVP-функции (итерация 1):
- Две панели (левая/правая), активная панель, переключение по `Tab`.
- Навигация: `Up/Down`, `Enter`, `Backspace`, переход к домашней директории.
- Операции: копировать, переместить, удалить (с подтверждением), создать папку.
- Сортировка: по имени/размеру/дате (переключаемые режимы).
- Поиск по имени в текущем каталоге.
- Строка подсказок с хоткеями и строка статуса (путь, число элементов, ошибки).

# Implementation

## Step 1: Bootstrap и каркас проекта
[x] Инициализировать `cargo`-проект (`bin`) и базовую структуру модулей.
[x] Подключить зависимости: `ratatui`, `crossterm`, `crossbeam-channel`, `walkdir`, `anyhow`, `thiserror`, `tracing`, `tracing-subscriber`.
[x] Описать базовые сущности: `AppState`, `PanelState`, `FsEntry`, `Command`, `Event`, `Job`.
[x] Добавить graceful shutdown и восстановление терминала при panic/ошибке.

## Step 2: Слой доменной модели и FS-адаптер
[x] Реализовать POSIX-ориентированный FS-адаптер (листинг, stat, mkdir, remove, rename/move, copy).
[x] Ввести нормализацию и валидацию путей (absolute/canonical где нужно).
[x] Добавить сортировки (name/size/mtime) и базовую фильтрацию скрытых файлов.
[x] Подготовить единый тип ошибок с понятной классификацией (permission, not found, io).

## Step 3: Event loop и конкурентная модель
[x] Реализовать главный цикл обработки: input events, ticks, worker responses.
[x] Поднять worker pool для долгих операций (copy/move/delete) через каналы.
[x] Добавить очередь задач и модель прогресса (`Queued`, `Running`, `Done`, `Failed`).
[x] Гарантировать неизменность UI-потока: любые тяжелые операции только через воркеры.

## Step 4: Базовый UI (две панели)
[x] Собрать layout: header, две панели, status bar, help bar.
[x] Реализовать визуальные состояния: активная панель, выделение, пустой каталог, ошибка.
[x] Добавить адаптацию к resize терминала.
[x] Настроить компактный рендер без лишних перерисовок состояния.

## Step 5: Навигация и управление фокусом
[x] Горячие клавиши: `Tab`, `Up/Down`, `Enter`, `Backspace`, `q`.
[x] Переход по каталогам и корректная обработка `..`.
[x] Поддержать быстрый jump в домашний каталог.
[x] Синхронизировать UI и `AppState` без рассогласований между панелями.

## Step 6: Файловые операции MVP
[x] Копирование из активной панели в неактивную (через job).
[x] Перемещение из активной панели в неактивную (через job).
[x] Удаление (permanent) с обязательным confirm-диалогом.
[x] Создание директории в активной панели.
[x] Показ результата операции и ошибок в status/log области.

## Step 7: Поиск и сортировка
[x] Реализовать поиск по подстроке имени в текущем каталоге (инкрементально).
[x] Добавить переключение режимов сортировки хоткеем.
[x] Сохранить выбранную сортировку per-panel.
[x] Обновлять видимый список без блокировки UI.

## Step 8: UX-доработки и надежность
[x] Добавить модальные окна подтверждений и ошибок (удаление/конфликты).
[x] Ввести стратегию конфликтов имен при copy/move (минимум: abort + сообщение).
[x] Улучшить сообщения об ошибках с контекстом пути/операции.
[x] Добавить guard-rails для опасных действий (удаление директории, permission denied).

## Step 9: Проверка производительности и релиз v1
[x] Smoke-проверка на больших каталогах (время первого листинга, latency навигации).
[x] Проверка поведения под долгими задачами копирования (UI отзывчив).
[x] Подготовить README: хоткеи, ограничения POSIX-first, known issues.
[x] Сформировать backlog для итерации 2 (архивы, предпросмотр, multi-select, tabs).

## Step 10: Rename Dialogs и табличный UI
[x] Добавить окно изменения имени для copy/move перед постановкой job.
[x] Показать список файлов в колонках `Name | Size | Modified`.
[x] Сохранить цветовую дифференциацию file/dir/symlink и корректный highlight selection.

# Definition of Done (итерация 1)
[x] Двухпанельная навигация стабильна и без UI-фризов.
[x] Основные операции (copy/move/delete/mkdir) выполняются через jobs и отображают статус.
[x] Поиск и сортировка работают в обеих панелях.
[x] Терминал корректно восстанавливается после штатного/аварийного выхода.
[x] Документация по запуску и хоткеям готова.

# Description (итерация 2)
Цель: сделать UX ближе к Midnight Commander для массовых операций и улучшить визуальную стабильность интерфейса.

Принятые решения:
- Selection-модель: MC-like (`Ins/Space`, `+/-/*`, диапазон `Shift+стрелки`).
- Таблица файлов: фиксированные колонки (`Name 64% | Size 14% | Modified 22%`).
- Нижнее меню: context-sensitive кнопки `F1..F10`.
- Диалоги: полноценные окна с кнопками (`[ OK ] [ Cancel ]`), фокусом и навигацией `Tab/Shift+Tab/Enter`.

Нефункциональные требования:
- Геометрия колонок не должна прыгать от длины имени файла.
- Диалоги должны быть единообразны по стилю и управлению.
- Массовые операции не должны блокировать UI.

# Implementation (итерация 2)

## Step 11: Selection Engine (MC-like)
[x] Добавить в `PanelState` модель multi-select (`selected_paths`, `selection_anchor`).
[x] Реализовать `Space/Ins` (toggle current), `+` (select by mask), `-` (deselect by mask), `*` (invert).
[x] Реализовать диапазонное выделение (`Shift+Up/Down`) с anchor-позицией.
[x] В status bar показывать счетчик выделенных (`selected N items / bytes`).

## Step 12: Batch Operations поверх selection
[x] Изменить `F5/F6/F8` на работу с набором выбранных элементов (если выбор пуст, использовать current).
[x] Добавить preflight-валидацию пакета: виртуальные записи, дубликаты, конфликтные target paths.
[x] Показать сводный confirm перед batch delete/move/copy (кол-во, объем, риски).
[x] Вести агрегированный прогресс/ошибки по пачке в activity log.

## Step 13: Стабильный табличный layout
[] Зафиксировать ширины колонок от ширины панели: `64/14/22` без перерасчета от контента.
[] Добавить предсказуемое обрезание имени (`…`) и выравнивание `Size/Modified`.
[] Проверить поведение на узком терминале: fallback к compact-таблице без “ломания” сетки.
[] Обновить рендер заголовка таблицы и highlight выбранных строк без дрожания.

## Step 14: UI Kit для диалогов с кнопками
[] Ввести общий компонент диалога: title/body/footer buttons/focused button.
[] Реализовать навигацию по кнопкам: `Tab/Shift+Tab`, `Left/Right`, `Enter`, `Esc`.
[] Перевести текущие confirm/alert/rename в новый компонент с кнопками.
[] Поддержать ускорители кнопок (`Alt+буква`) для частых действий.

## Step 15: Нижнее меню F-key в стиле MC
[] Реализовать визуальные кнопки `F1..F10` в footer (`[F5 Copy] [F6 Move] ...`).
[] Сделать context-sensitive наборы:
[] `Normal`: базовые действия.
[] `Selection`: batch-операции.
[] `Dialog`: кнопки активного диалога (`OK/Cancel/Apply`).
[] Подсветка disabled/active состояний для прозрачного UX.

## Step 16: Полировка и валидация итерации 2
[] Smoke-сценарии для multi-select и batch copy/move/delete.
[] Проверка стабильности layout на разных размерах терминала.
[] Обновить README: новые hotkeys, selection flow, dialog controls.
[] Добавить раздел Known UX constraints и дальнейший backlog (preview, tabs, bookmarks).

# Definition of Done (итерация 2)
[] Multi-select работает предсказуемо и покрывает MC-like сценарии.
[] Batch-операции безопасны и дают понятные сводные подтверждения/ошибки.
[] Колонки стабильны и не меняют геометрию от длины имени.
[] Все диалоги выглядят единообразно, имеют кнопки и управляются с клавиатуры.
[] Нижнее меню F-кнопок контекстно соответствует режиму экрана.
